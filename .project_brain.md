# 项目笔记本 [v7]
## 核心原则
*   [P1] UI数据必须保持一致性。
*   [P2] 异步数据加载需要有明确的加载状态。
*   [P3] 派生状态应使用 `useMemo` 缓存。
*   [P4] 全局统计数据应在数据处理层去重计算。
*   [P5] UI应保持简洁，移除冗余信息。
*   [P6] 移除生产环境中不必要的调试日志。
*   [P7] 项目应保持整洁，移除无关的测试和构建文件。
*   [P8] **[新增]** 大数据量场景下应优化排序算法复杂度，使用 Map 替代 Array.indexOf。
*   [P9] **[新增]** 大对象应存储在 useRef 中，仅在 React state 中保存触发重渲染的关键信息。
*   [P10] **[新增]** UI操作按钮必须连接到实际的业务逻辑，避免"假操作"。

## 系统地图
用户交互(混合模式) → `PracticeOverlay.tsx` → `usePracticeData.tsx` → `queries.ts` → Roam DB
牌组管理 → `DeckPriorityManager.tsx` → `handleDeckOffsetApply` → `bulkSaveRankingChanges` → Roam DB

## 风险清单
*   ✅ **[已解决]** ~~数据不一致风险~~
*   ✅ **[已解决]** ~~潜在UI混淆风险~~
*   ✅ **[已解决]** ~~控制台日志过于冗余~~
*   ✅ **[已解决]** ~~项目包含非必要的开发者文件~~
*   ✅ **[已解决]** ~~几千张卡片时排序性能瓶颈 (O(N²) → O(N log N))~~
*   ✅ **[已解决]** ~~React 大对象频繁重渲染问题~~
*   ✅ **[已解决]** ~~牌组优先级偏移功能无效 - 保存按钮未实现实际逻辑~~

## 工作日志
*   [D-6] 修复了UI数据显示不一致的问题。
*   [D-5] 简化了UI，移除了冗余的全局待学信息。
*   [D-4] 精简了代码中的调试日志。
*   [D-3] 移除了项目中所有测试文件、构建脚本和临时文件。
*   [D-2] **完成P0性能优化**: 引入 rankMap 替代 indexOf，修正 TypeScript 类型定义。
*   [D-1] **完成P1性能优化**: 将大对象移至 useRef，添加卡片预取，减少重渲染。
*   [D-0] **修复牌组偏移bug**: 实现 `DeckPriorityManager` 的保存逻辑，连接偏移计算与数据持久化。

## 知识晶体
*   💎 **Single Source of Truth**: 派生状态应在数据处理流水线末端计算一次，作为唯一可信源。
*   💎 **Minimalist UI**: 优先展示核心数据，移除可能混淆的辅助信息。
*   💎 **Production Logging**: 生产代码应移除详细的调试日志，只保留关键错误和警告。
*   💎 **Code Hygiene**: 定期清理与项目核心功能无关的开发依赖、脚本和测试文件。
*   💎 **Build Process**: 在交付前，必须通过 `npm install` 和 `npm run build` 确保所有依赖正确安装并生成最新的生产版本。
*   💎 **Algorithm Optimization**: 大数据量下用 Map 查找替代 Array 线性搜索，可将排序从 O(N²) 优化至 O(N log N)。
*   💎 **React Performance**: 将大对象存储在 useRef 中，只在 state 中保存版本号，可显著减少无意义的重渲染。
*   💎 **Prefetching Strategy**: 预取下一个即将使用的资源（如 blockInfo），可提升用户感知的响应速度。
*   💎 **UI-Business Logic Connection**: UI操作按钮必须连接到完整的业务逻辑链，包括数据计算、持久化和前端状态刷新，避免只有表面效果的"假操作"。 