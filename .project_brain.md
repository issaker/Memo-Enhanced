# 项目笔记本 [v0]
## 核心原则 (根据交接报告提炼)
- [P1] **异步防御**: 任何从 `roamAlphaAPI` 或其他异步来源获取的数据，在使用前必须经过严格的 `null/undefined` 检查。
- [P2] **简单查询优先**: 优先使用简单的 Datalog 查询获取大数据集，然后在 JavaScript 中进行精确过滤，避免复杂的 Datalog 语法。
- [P3] **懒保存模式**: 对于频繁的写操作，应遵循现有的"懒保存"模式，将变更暂存，在最后统一批量写入，以减少 API 调用。

## 系统地图 (关键模块关系)
- `PracticeOverlay` (主UI) ← `useSettings`, `usePracticeData`, `useDeckPriority`
- `DeckPriorityManager` (优先级管理) ← `useDeckPriority`
- `useSettings` (设置钩子) → [风险#1]
- `useDeckPriority` (优先级钩子) → [风险#2]
- `queries/save` (保存逻辑) → `bulkSaveRankingChanges` → [风险#3]

## 风险清单 (从报告中识别)
- ⚠️📌 **[风险#1] 异步初始化崩溃**: `useSettings` 在加载初期 `tagsListString` 为 `null`，直接操作导致插件崩溃。 (报告称已修复，但需评估其健壮性)
- ⚠️📌 **[风险#2] 依赖未定义崩溃**: `useDeckPriority` 依赖的 `priorityOrder` 数组异步加载，在此期间为 `undefined`，导致调用方法时崩溃。(报告称已修复，但需评估)
- ⚠️⏱ **[风险#3] 批量保存性能瓶颈**: `bulkSaveRankingChanges` 在处理大量卡片（如 >5000 张）时可能存在性能问题。
- ⚠️ **[风险#4] 优先级重复计算**: `useDeckPriority` 每次打开管理器时都重新计算所有牌组的中位数，存在性能优化空间。

## 工作日志 (倒序3条)
- [D-0] 接收 v2.2.0 交接报告，开始代码审查和优化工作。
- [D-1] (前任Agent) ✅ 完成"全局混合学习"与"批量优先级调整"功能。
- [D-2] (前任Agent) ⚠️ 解决因异步加载 `null` 值导致的多个白屏问题。

## 知识晶体 (可复用的模式)
- 💎 **AsyncGuard**: 在异步数据返回之前，提供默认值或加载状态，防止下游组件因 `null` 值崩溃。
- 💎 **LazySave**: 将变更暂存于 `state`，在组件卸载或特定时机通过单个函数 `bulkSave` 统一写入。
- 💎 **FetchThenFilter**: 先捞后筛，用 JS 灵活性弥补 Datalog 查询复杂性的短板。 